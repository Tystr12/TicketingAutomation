<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Ticket Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
  body { font-family: system-ui, Arial; margin: 24px; }
  header { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  input, select, button { padding:8px; }
  table { width:100%; border-collapse: collapse; margin-top:16px; }
  th, td { border-bottom:1px solid #eee; padding:8px; text-align:left; }
  .muted { color:#666; font-size:12px; }
  form.inline { display:flex; gap:8px; align-items:center; }
  tr:hover { background:#fafafa; }

  /* Base pill: give a safe default bg so text never “disappears” */
  .pill {
    padding:4px 10px; border-radius:999px; font-size:12px;
    font-weight:600; letter-spacing:.5px; text-transform:uppercase;
    color:#fff; background:#6b7280; display:inline-block; /* gray fallback */
  }

  /* Status colors (higher specificity so they always override) */
  .pill.open   { background:#22c55e; }  /* green */
  .pill.closed { background:#ef4444; }  /* red  */

  /* Priority colors */
  .pill.priority-low    { background:#3b82f6; }            /* blue   */
  .pill.priority-medium { background:#facc15; color:#111; }/* yellow + dark text */
  .pill.priority-high   { background:#f97316; }            /* orange */
</style>


</head>
<body>

<header>
  <h2 style="margin-right:auto">Ticket Dashboard</h2>

  <!-- Search/filter form (GET) -->
  <form class="inline" method="get">
    <input type="text" name="q" placeholder="Search title/desc/category" value="{{ q }}">
    <select name="status">
      <option value="">All status</option>
      <option value="open" {% if status == 'open' %}selected{% endif %}>Open</option>
      <option value="closed" {% if status == 'closed' %}selected{% endif %}>Closed</option>
    </select>
    <input type="text" name="category" placeholder="Category (Printer, Network...)" value="{{ category }}">
    <select name="ordering">
      <option value="-created_at" {% if ordering == '-created_at' %}selected{% endif %}>Newest</option>
      <option value="created_at" {% if ordering == 'created_at' %}selected{% endif %}>Oldest</option>
      <option value="priority" {% if ordering == 'priority' %}selected{% endif %}>Priority</option>
    </select>
    <button type="submit">Filter</button>
  </form>
</header>

<p class="muted">Auto-refreshes every 15s. <span id="last"></span></p>

<table id="table">
  <thead>
    <tr>
      <th>Title</th>
      <th>Status</th>
      <th>Priority</th>
      <th>Category</th>
      <th>Duplicate</th>
      <th>Created</th>
    </tr>
  </thead>
  <tbody id="tbody">
    {% for t in tickets %}
    <tr>
  <td>{{ t.title }}</td>

  <!-- Status pill -->
  <td>
    <span class="pill {{ t.status|lower }}">
      {{ t.status|upper }}
    </span>
  </td>

  <!-- Priority pill -->
  <td>
    <span class="pill
      {% if t.priority == 1 %}priority-high
      {% elif t.priority == 2 %}priority-medium
      {% else %}priority-low
      {% endif %}">
      {% if t.priority == 1 %}HIGH
      {% elif t.priority == 2 %}MEDIUM
      {% else %}LOW
      {% endif %}
    </span>
  </td>

  <td>{{ t.category|default:"—" }}</td>
  <td>{{ t.is_duplicate|yesno:"Yes,No" }}</td>
  <td>{{ t.created_at|date:"Y-m-d H:i" }}</td>
</tr>

    {% endfor %}
  </tbody>
</table>

<!-- Simple pager -->
<p id="pager">
  {% if tickets.has_previous %}
    <a href="?page={{ tickets.previous_page_number }}&q={{ q }}&status={{ status }}&category={{ category }}&ordering={{ ordering }}">Prev</a>
  {% endif %}
  Page {{ tickets.number }} of {{ tickets.paginator.num_pages }}
  {% if tickets.has_next %}
    <a href="?page={{ tickets.next_page_number }}&q={{ q }}&status={{ status }}&category={{ category }}&ordering={{ ordering }}">Next</a>
  {% endif %}
</p>



<script>
function stamp() {
  const el = document.getElementById("last");
  if (el) el.textContent = "Last updated " + new Date().toLocaleTimeString();
}

async function refreshPartial() {
  // Re-fetch the same paged URL (?page=..., filters, ordering preserved)
  const res = await fetch(window.location.href, { headers: { "X-Requested-With": "fetch" } });
  const html = await res.text();
  const doc = new DOMParser().parseFromString(html, "text/html");

  // Swap table body
  const newTbody = doc.getElementById("tbody");
  const tbody = document.getElementById("tbody");
  if (newTbody && tbody) tbody.innerHTML = newTbody.innerHTML;

  // Swap pager
  const newPager = doc.getElementById("pager");
  const pager = document.getElementById("pager");
  if (newPager && pager) pager.innerHTML = newPager.innerHTML;

  stamp();
}

// Initial stamp + refresh every 15s
stamp();
setInterval(refreshPartial, 15000);
</script>



</body>
</html>
